<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brains@Play Docs</title>
    <style>
* {
  box-sizing: border-box;
}

html, body {
    margin: 0;
    padding: 0;
    height: 100vh;
    width: 100vw;
}

body {
  padding: 0px 50px;
}
</style>
    <link rel=stylesheet href="../../../../static/custom.css"/>
    <link rel="icon" href="../../../../static/img/favicon.ico" type="image/x-icon" />
</head>
<body>
    <nav></nav>
    <h2 id="wssbackend">WSSbackend</h2>
<p>This WSSbackend provides websocket server and websocket tools with one-liner configuration. Chain this with the HTTPbackend or use any generic http/https server. This uses the <a href="https://github.com/websockets/ws"><code>ws</code></a> library which includes the websocket server spec that is not default in Node.js.</p>
<p>Socket server clients can subscribe to node states on the socket server as well so it's easy to set up listener logic in your flow graph.</p>
<p>The default onmessage function handles service calls with jsonified commands. You can overwrite this or add custom listeners in parallel, everything else follows standard WebSocket API usage.</p>
<pre><code class="ts language-ts">//e.g.. let served = await http.setupServer(...) from HTTPBackend

import {WSSbackend} from 'graphscript-node'


export type SocketServerProps = {
    server:http.Server|https.Server,
    host:'localhost'|'127.0.0.1'|string,
    port:7000|number,
    path:'wss'|'hotreload'|'python'|string,
    onmessage?:(data:any, ws:WebSocket, serverinfo:SocketServerInfo)=&gt;void,
    onclose?:(wss:WebSocketServer, serverinfo:SocketServerInfo)=&gt;void,
    onconnection?:(ws:WebSocket,request:http.IncomingMessage, serverinfo:SocketServerInfo, clientId:string)=&gt;void,
    onconnectionclosed?:(code:number,reason:Buffer,ws:WebSocket, serverinfo:SocketServerInfo, clientId:string)=&gt;void,
    onerror?:(err:Error, wss:WebSocketServer, serverinfo:SocketServerInfo)=&gt;void,
    onupgrade?:(ws:WebSocket, serverinfo:SocketServerInfo, request:http.IncomingMessage, socket:any, head:Buffer)=&gt;void, //after handleUpgrade is called
    keepState?:boolean,
    type?:'wss',
    [key:string]:any
}

export type SocketServerInfo = {
    wss:WebSocketServer,
    clients:{[key:string]:WebSocket}, //corresponding socket controls are found in this.sockets for each clientId
    address:string,
    send:(message:any,socketId?:string)=&gt;void,
    request:(message:any, method?:string, socketId?:string)=&gt;Promise&lt;any&gt;|Promise&lt;any&gt;[],
    post:(route:any, args?:any, method?:string, socketId?:string)=&gt;void,
    run:(route:any, args?:any, method?:string, socketId?:string)=&gt;Promise&lt;any&gt;|Promise&lt;any&gt;[],
    subscribe:(route:any, callback?:((res:any)=&gt;void)|string, socketId?:string)=&gt;Promise&lt;number&gt;|Promise&lt;number&gt;[]|undefined,
    unsubscribe:(route:any, sub:number,socketId?:string)=&gt;Promise&lt;boolean&gt;|Promise&lt;boolean&gt;[],
    terminate:(socketId?:string)=&gt;boolean,
    graph:WSSbackend
} &amp; SocketServerProps;


const wss = new WSSbackend({loadDefaultRoutes:true});

let socketserver = wss.setupWSS(
    {
        server:served.server, //e.g. returned from httpbackend.setupServer
        host:served.host,
        port:8081,
        path:'wss',
        onconnection:(ws,req,serverinfo,id)=&gt;{
            ws.send('Hello from WSS!');
        }
    } as SocketServerProps
) as SocketServerInfo;
</code></pre>
<p>To open a websocket connection from node to another server</p>
<pre><code class="ts language-ts">export type SocketProps = {
    host?:string,
    port?:number,
    path?:string,
    socket?:WebSocket,
    address?:string,
    serverOptions?:WebSocket.ServerOptions
    onmessage?:(data:string | ArrayBufferLike | Blob | ArrayBufferView | Buffer[], ws:WebSocket,wsinfo:SocketProps)=&gt;void,  //will use this.receive as default
    onopen?:(ws:WebSocket,wsinfo:SocketProps)=&gt;void,
    onclose?:(code:any,reason:any,ws:WebSocket,wsinfo:SocketProps)=&gt;void,
    onerror?:(er:Error, ws:WebSocket,wsinfo:SocketProps)=&gt;void,
    protocol?:'ws'|'wss',
    type?:'socket',
    _id?:string,
    keepState?:boolean
}

export type SocketInfo = {
    socket:WebSocket,
    address?:string,
    send:(message:any)=&gt;void,
    request:(message:any, method?:string)=&gt;Promise&lt;any&gt;,
    post:(route:any, args?:any, method?:string)=&gt;void,
    run:(route:any, args?:any, method?:string)=&gt;Promise&lt;any&gt;,
    subscribe:(route:any, callback?:((res:any)=&gt;void)|string)=&gt;any,
    unsubscribe:(route:any, sub:number)=&gt;Promise&lt;boolean&gt;,
    terminate:()=&gt;void,
    graph:WSSbackend
} &amp; SocketProps;

let socketinfo = wss.openWS({
    host:'localhost',
    port:8081
} as SocketProps) as SocketInfo;

//e.g..
socketinfo.subscribe('ping', console.log); //ping is available if loadDefaultRoutes is set to true when initializing a service
socketinfo.post('ping');
</code></pre>
    <footer></footer>
</body>
</html>
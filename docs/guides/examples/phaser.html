<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brains@Play Docs</title>
    <link rel=stylesheet href="../../.docs/default.css"/>
    <link rel=stylesheet href="../../static/custom.css"/>
    <link rel="icon" href="../../static/img/favicon.ico" type="image/x-icon" />
</head>
<body>
    <header>
        <nav><h1>Brains@Play</h1></nav>
    </header>
    <section>
        <h2 id="using-the-brainsplay-framework-with-phaser-3">Using the Brains@Play Framework with Phaser 3</h2>
<p>This tutorial will use the <a href="https://phaser.io/">Phaser</a> library (v3) to introduce the core concepts of the Brains@Play Framework through a complete example.</p>
<blockquote>
  <p>Our <a href="https://github.com/garrettmflynn/components">components</a> repository contains the <a href="https://github.com/brainsatplay/components/blob/main/demos/phaser">demo</a> and <a href="https://github.com/brainsatplay/components/blob/main/components/phaser">Component</a> code for this example. </p>
</blockquote>
<h2 id="a-tour-of-the-plugins">A Tour of the Plugins</h2>
<p>We have created a <a href="../getting-started/conventions.md#native-vs-mashup">mashup component</a> to simplify the process of working with Phaser.</p>
<h3 id="phaser">phaser</h3>
<p>This plugin is a <strong>Factory</strong> for the global <code>Phaser</code> variable loaded asynchronously with a <code>script</code> tag.</p>
<h4 id="full-code">Full Code</h4>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>const script = document.createElement('script')
script.src = 'https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser-arcade-physics.min.js'
document.head.appendChild(script)

let nodes = {}
let onResolve = null
script.onload = function () {
    if (onResolve instanceof Function) onResolve(window.Phaser)
    for (let tag in nodes)  nodes[tag].run()
};

export function oncreate() {
    if (window.Phaser) this.run()
    else nodes[this.tag] = this
}

export default () =&gt; {
    if (window.Phaser) return window.Phaser
    else return new Promise(resolve =&gt; onResolve = resolve)
}
</code></pre></div>
<h4 id="detailed-explanation">Detailed Explanation</h4>
<h5 id="external-library-import">External Library Import</h5>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>const script = document.createElement('script')
script.src = 'https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser-arcade-physics.min.js'
document.head.appendChild(script)

// ...

script.onload = function () {
    if (onResolve instanceof Function) onResolve(window.Phaser)
    for (let tag in nodes)  nodes[tag].run()
};
</code></pre></div>
<p>This snippet asynchronously loads Phaser as a <code>window</code> variable into the page. Once loaded, the default export for this plugin will be forwarded to any children. </p>
<p>The <code>onResolve</code> function ensures that requests made before the availability of <code>window.Phaser</code> will be passed properly.</p>
<h5 id="node-registration">Node Registration</h5>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>export function oncreate() {
    if (window.Phaser) this.run()
    else nodes[this.tag] = this
}
</code></pre></div>
<p>This snippet collects graph nodes (using the <code>this</code> keyword) for later activation in the <code>script.onload</code> functionâ€”or simply runs the node if <code>window.Phaser</code> is available.</p>
<blockquote>
  <p>The <code>this</code> keyword specifies the parent object of a function. In <code>wasm</code>, the underlying library for <code>brainsatplay</code>, <code>this</code> is always the class that controls the plugin execution.</p>
</blockquote>
<h5 id="simple-forwarding-function">Simple Forwarding Function</h5>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>export default () =&gt; {
    if (window.Phaser) return window.Phaser
    else return new Promise(resolve =&gt; onResolve = resolve)
}
</code></pre></div>
<p>This snippet forwards <code>window.Phaser</code> to all children.</p>
<h3 id="config">config</h3>
<h4 id="full-code-1">Full Code</h4>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>import merge from './merge.js';  // A module that merges two object
import defaultConfig from './phaser.config.js' // A default configuration file for Phaser

export const content = defaultConfig
export default function () {
    if (window.Phaser) {
        let cfg = (typeof this.content === 'function') ? this.content(window.Phaser) : this.content;
        let defaultCfg = (typeof content === 'function') ? content(window.Phaser) : content;
        let config = merge(defaultCfg, cfg)
        config.parent =  this.parentNode
        return config
    }
}
</code></pre></div>
<h4 id="detailed-explanation-1">Detailed Explanation</h4>
<h5 id="custom-instance-keys">Custom Instance Keys</h5>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>export const content = defaultConfig
</code></pre></div>
<p>This snippet adds a custom key (<strong>content</strong>) to each plugin instance, which allows users to specify a configuration object from inside WASL files.</p>
<h5 id="using-a-default-template">Using a Default Template</h5>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>export default function () {
    if (window.Phaser) {
         let cfg = (typeof this.content === 'function') ? this.content(window.Phaser) : this.content;
        let defaultCfg = (typeof content === 'function') ? content(window.Phaser) : content;
        let config = merge(defaultCfg, cfg)
        config.parent =  this.parentNode
        return config
    }
}
</code></pre></div>
<p>This snippet uses a regular (as opposed to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">arrow</a>) function and the <code>this</code> keyword to access a user-specified configuration and options object. These are then merged with the default objects.</p>
<p>The <code>parent</code> of the Phaser configuration object is also set to the parentNode of the current instance. This allows the game to be placed inside the HTMLElement assigned to the instance on the webpage.</p>
<h3 id="game">game</h3>
<h4 id="full-code-2">Full Code</h4>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>export default (config) =&gt; new Phaser.Game(config);
</code></pre></div>
<h4 id="detailed-explanation-2">Detailed Explanation</h4>
<p>As the simplest plugin of this collection, this simply creates a <code>Phaser.Game</code> instance that is added to the webpage (based on the aforementioned <code>parent</code> key) and forwarded to any children.</p>
<h2 id="assembling-the-phaser-component">Assembling the <code>phaser</code> Component</h2>
<p>This <code>phaser</code> component is a simple series of the aforementioned plugins.</p>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>{
    "graph": {

        "nodes": {
            "phaserObject": {
                "src": "plugins/phaser/index.js"
            },
            "config": {
                "src": "plugins/config/index.js"
            },
            "game": {
                "src": "plugins/game/index.js"
            }
        },
        "edges": {
            "phaserObject": {
                "config": {},
            },
            "config": {
                "game": {}
            }
        }
    }
}
</code></pre></div>
<h2 id="phaser-component-usage"><code>phaser</code> Component Usage</h2>
<p>To instantiate a Phaser game in your app, you may add this node to your <code>index.wasl.json</code> file: </p>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>{
    "graph": {

        "nodes": {
            "phaser": {
                "src": "phaser/index.wasl.json",
            }
        },

        "edges": {}
    }
}
</code></pre></div>
<h3 id="modifying-the-phaser-component">Modifying the <code>phaser</code> Component</h3>
<p>To modify <code>phaser</code> for your app, add the <code>plugins</code> field under <code>graph.nodes.phaser</code>. This will allow you to merge your <code>content</code> information with the default.</p>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>{
    "graph": {

        "nodes": {
            "phaser": {
                "src": "phaser/index.wasl.json",
                "plugins": {
                    "config": {
                        "content": {
                            "physics": {
                                "arcade": {
                                    "gravity": {
                                        "y": 20000
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },

        "edges": {}
    }
}
</code></pre></div>
<h2 id="running-wasl-with-brainsatplay">Running WASL with <code>brainsatplay</code></h2>
<p>The following HTML document can be used to run your WASL app.</p>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;title&gt;Phaser App&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;script type="module"&gt;

    import * as brainsatplay from 'https://cdn.jsdelivr.net/npm/brainsatplay/dist/index.esm.js'

    const app = new brainsatplay.App('./index.wasl.json', {
        relativeTo: import.meta.url
    })    

    const ui = document.querySelector('div')
    ui.style.width = '100vw'
    ui.style.height = '100vh'
    app.setParent(ui)

    app.start().then(ok =&gt; {
        if (ok) console.log('App started', app)
        else console.log('App failed', app)
    }).catch(e =&gt; console.error('Invalid App', e))

&lt;/script&gt;

&lt;/html&gt;
</code></pre></div>
<h4 id="import-mode">Import Mode</h4>
<p>If your app's plugins are served to the browser alongside the HTML document, you may use <strong>import mode</strong> to dynamically import these plugins using the relative path from the HTML file and the <code>import.meta.url</code> variable, which indicates the location of the current script in the browser filesystem.</p>
<h4 id="reference-mode">Reference Mode</h4>
<p>If you cannot use <strong>import mode</strong> (e.g. your application is housed in a sibling repository), you may also use <strong>reference mode</strong> to provide object references to all the files that compose it.</p>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>import info from '../../phaser/index.wasl.json' assert {type: "json"}
import phaserInfo from '../../phaser/src/index.wasl.json' assert {type: "json"}

import pkg from '../../phaser/package.json'  assert {type: "json"}
import phaserPkg from '../../phaser/src/package.json'  assert {type: "json"}
import * as phaser from  '../../phaser/src/plugins/phaser/index.js'
import * as config from  '../../phaser/src/plugins/config/index.js'
import * as game from  '../../phaser/src/plugins/game/index.js'

const path = '../../phaser/index.wasl.json'

const options = {
    filesystem: {
        'package.json': pkg,
        'src/package.json': phaserPkg,
        'src/index.wasl.json': phaserInfo,
        'src/plugins/phaser/index.js': phaser,
        'src/plugins/config/index.js': config,
        'src/plugins/game/index.js': game
    }
}

const app = new brainsatplay.App(info, options)   
</code></pre></div>
<p>After serving this HTML document, you should have an active version of the default <code>phaser</code> game running!</p>
<h2 id="programming-with-the-phaser-component">Programming with the <code>phaser</code> Component</h2>
<h4 id="linking-to-code-files">Linking to Code Files</h4>
<p>If you have ESM files (e.g. with functions) that you'd like to import into a plugin, you may simply provide URIs linking to them:</p>
<blockquote>
  <p>If the <em>default</em> export is the only one available, it will replace the enclosing object. Otherwise all named exports will be added to the object.</p>
</blockquote>
<div class="brainsatplay-docs-code"><span>Code</span>
<pre><code>{
    "graph": {

        "nodes": {
            "phaser": {
                "src": "phaser/index.wasl.json",
                "plugins": {
                    "config": {
                        "content": {
                            "physics": {
                                "arcade": {
                                    "gravity": {
                                        "y": 20000
                                    }
                                },
                                "scene": {
                                    "key": "main",
                                    "preload": {
                                        "src": "./scripts/preload.js"
                                    },
                                    "create": {
                                        "src": "./scripts/create.js"
                                    },
                                    "update": {
                                        "src": "./scripts/update.js"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
</code></pre></div>
<h2 id="creating-plugins-from-phaser-scripts">Creating Plugins from Phaser Scripts</h2>
<p><em>Coming Soon</em></p>
    </section>
    <footer></footer>
</body>
</html>